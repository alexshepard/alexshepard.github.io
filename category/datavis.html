<!DOCTYPE html>
<html lang="en">
<head>
        <title>Alex's Blog - datavis</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://alexshepard.github.io/theme/css/main.css" type="text/css" />
        <link href="https://alexshepard.github.io/None" type="application/atom+xml" rel="alternate" title="Alex's Blog ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://alexshepard.github.io/css/ie.css"/>
                <script src="https://alexshepard.github.io/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://alexshepard.github.io/css/ie6.css"/><![endif]-->

</head>

<body>
        
        

            <header>
                <h1><a href="https://alexshepard.github.io" id="site-title">Alex's Blog </a> : <a href="https://alexshepard.github.io/inaturalist-observations-us-states-chart-race.html" id="page-title">iNaturalist Observations US States Chart Race</a></h1>
<time datetime="2022-11-27T22:12:03-08:00">Sun 27 November 2022</time>            </header>

            <article>
                <script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-time@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-time-format@4"></script>

<div id="app">
</div>

<script>

const w = 800;
const h = 800;
const padding = 30;

const appViz = d3.select("#app")
    .append("svg")
    .attr("width", w)
    .attr("height", h);

const chart = appViz.append("g");
const xaxisGroup = appViz.append("g");
const chartLabels = appViz.append("g");
const titleGroup = appViz.append("g");

const epochParser = d3.timeParse("%Q");
const formatMonth = d3.timeFormat('%Y');

const main = async () => {
    const inatStates = await d3.json("/assets/inat_states_cumsum.json");
    const dateKeys = [];

    for (const [key, value] of Object.entries(inatStates["California"])) {
        dateKeys.push(+key);
    }

    const stateNames = [];
    const productivity = [];

    for (const [stateName, stats] of Object.entries(inatStates)) {
        stateNames.push(stateName);

        const values = [];
        for (const [_date, value] of Object.entries(stats)) {
            values.push(value);
        }

        productivity.push({
            name: stateName,
            values: values,
        });
    }

    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
    colorScale.domain(stateNames);

    const scaleX = d3.scaleLinear()
        .domain([0, 10]) // domain will adjust each interval
        .range([padding, w - padding])
        .nice();

    let interval = 0;
    setInterval(() => {
        if (interval >= dateKeys.length) {
            return;
        }

        productivity.sort((a, b) => d3.descending(a.values[interval], b.values[interval]));
        productivity.forEach((d, i) => d.rank = i);

        scaleX.domain([0, productivity[0].values[interval]]);

        const scaleY = d3.scaleBand()
            .domain(d3.range(productivity.length))
            .range([padding, h])
            .paddingInner(0.1);

        const t = d3.transition()
            .duration(300)
            .ease(d3.easeLinear);

        chart
            .selectAll("rect")
            .data(productivity, (d) => d.name)
            .join(
                enter => enter
                    .append("rect")
                    .attr("fill", (d) => {
                        return colorScale(d.name);
                    })
                    .attr("x", padding)
                    .attr("y", (d) => scaleY(d.rank))
                    .attr("width", (d) => scaleX(d.values[interval]) - padding)
                    .attr("height", scaleY.bandwidth()),
                update => update
                    .transition(t)
                    .attr("fill", (d) => {
                        return colorScale(d.name);
                    })
                    .attr("x", padding)
                    .attr("y", (d) => scaleY(d.rank))
                    .attr("width", (d) => scaleX(d.values[interval]) - padding)
                    .attr("height", scaleY.bandwidth()),
            )

        const tickValues = [
            10,
            100,
            1_000,
            10_000,
            100_000,
            1_000_000,
            10_000_000,
        ];

        if (productivity[0].values[interval] > 3_000) {
            tickValues.shift();
        }
        if (productivity[0].values[interval] > 30_000) {
            tickValues.shift();
        }
        if (productivity[0].values[interval] > 300_000) {
            tickValues.shift();
        }
        if (productivity[0].values[interval] > 3_000_000) {
            tickValues.shift();
        }
        if (productivity[0].values[interval] > 30_000_000) {
            tickValues.shift();
        }

        xaxisGroup
            .selectAll("g.x-axis")
            .data([null])
            .join("g")
            .transition(t)
            .attr("transform", `translate(0, 28)`)
            .attr("class", "x-axis")
            .call(d3.axisTop(scaleX)
                .tickValues(tickValues)
                .tickSizeOuter(0)
                .tickSizeInner(-1 * h)
            );

        xaxisGroup.selectAll(".tick line").attr("stroke", "white");
        xaxisGroup.select(".domain").remove();

        chartLabels
            .selectAll("text")
            .data(productivity, (d) => d.name)
            .join(
                enter => enter
                    .append("text")
                    .text((d) => d.name)
                    .style("font-size", "0.7em")
                    .attr("fill", (_d, i) => {
                        if (i == 0) {
                            return "white";
                        } else {
                            return "black";
                        }
                    })
                    .attr("text-anchor", (_d, i) => {
                        if (i == 0) {
                            return "end";
                        } else {
                            return "start";
                        }
                    })
                    .attr("alignment-baseline", "baseline")
                    .attr("x", (d, i) => {
                        if (i == 0) {
                            return scaleX(d.values[interval]) - 2;
                        } else {
                            return scaleX(d.values[interval]) + 2;
                        }
                    })
                    .attr("y", (d) => scaleY(d.rank) + 2),
                update => update
                    .transition(t)
                    .text((d) => d.name)
                    .attr("fill", (_d, i) => {
                        if (i == 0) {
                            return "white";
                        } else {
                            return "black";
                        }
                    })
                    .attr("text-anchor", (_d, i) => {
                        if (i == 0) {
                            return "end";
                        } else {
                            return "start";
                        }
                    })
                    .attr("alignment-baseline", "baseline")
                    .attr("x", (d, i) => {
                        if (i == 0) {
                            return scaleX(d.values[interval]) - 2;
                        } else {
                            return scaleX(d.values[interval]) + 2;
                        }
                    })
                    .attr("y", (d) => scaleY(d.rank) + 2),
            );

        const dateKey = dateKeys[interval % dateKeys.length];
        const parsedDate = epochParser(+dateKey)
        const title = formatMonth(parsedDate);
        titleGroup
            .selectAll("text")
            .data([null])
            .join("text")
            .attr("y", 12)
            .attr("x", w / 2)
            .attr("dx", ".35em")
            .attr("fill", "black")
            .attr("text-anchor", "middle")
            .text(`${title} Cumulative iNaturalist Observations, US States`);

        interval++;
    }, 300);
};

main();

</script>            </article>
                <section id="article-list">
                    <h2>All posts</h2>
                    <ol>
            </ol>
            </section><!-- #article-list -->
        

 
            <li><a href="https://alexshepard.github.io/chart-remake.html" rel="bookmark" title="Permalink to "Chart Remake"">"Chart Remake"</a></li>
            </ol>
            </section><!-- #article-list -->

        <footer>
            <nav>
                <ul>
                    <li>:: <a href="https://alexshepard.github.io/categories.html">Categories</a></li>
                    <li>:: <a href="https://alexshepard.github.io/tags.html">Tags</a></li>
                </ul>
            </nav>
                <p id="theme-credit"><a href="http://mathieu.agopian.info/mnmlist/theme.html">Th√®me mnmlist</a></p>
        </footer>

</body>
</html>